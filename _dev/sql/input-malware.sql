with malware as (SELECT 
  m.detectiontime as [timestamp],
  'SystemCenterEndpointProtection' AS vendor_product,
  'SecurityIncident' AS [type],
  --'MalwareInfection' AS action_type,
  m.resourceid, 
  sys.Netbios_Name0 as dest_name,
  sys.Resource_Domain_OR_Workgr0 as dest_nt_domain,
  m.detectiontime, 
  m.actiontime, 
  m.ProductVersion as product_version, 
  m.detectionid, 
  CASE  
    WHEN m.DetectionSource = 0 THEN 'unknown' 
    WHEN m.DetectionSource = 1 THEN 'user' 
    WHEN m.DetectionSource = 2 THEN 'system' 
    WHEN m.DetectionSource = 3 THEN 'realtime' 
    WHEN m.DetectionSource = 4 THEN 'ioav' 
    WHEN m.DetectionSource = 5 THEN 'nis' 
    WHEN m.DetectionSource = 6 THEN 'bho'  
  END AS detection_source,
  m.UserName as [user],
  m.Process AS target_process, 
  m.Path AS file_path, 
  ISNULL(metaData.Name,'unknown') AS [signature], 
  IsNULL(sev.Severity,'unknown') AS severity, 
  IsNULL(cat.Category,'invalid') AS category,
  CASE  
    WHEN CleaningAction = 0 THEN 'unknown' 
    WHEN CleaningAction = 1 THEN 'clean' 
    WHEN CleaningAction = 2 THEN 'quarantine' 
    WHEN CleaningAction = 3 THEN 'remove' 
    WHEN CleaningAction = 6 THEN 'allow' 
    WHEN CleaningAction = 8 THEN 'userdefined' 
    WHEN CleaningAction = 9 THEN 'noaction' 
    WHEN m.CleaningAction = 10 THEN N'block' 
  END AS action_type, 
  CASE  
    WHEN CleaningAction = 0 THEN 'unknown' 
    WHEN CleaningAction = 1 THEN 'blocked' 
    WHEN CleaningAction = 2 THEN 'deferred' 
    WHEN CleaningAction = 3 THEN 'blocked' 
    WHEN CleaningAction = 6 THEN 'allowed' 
    WHEN CleaningAction = 8 THEN 'unknown' 
    WHEN CleaningAction = 9 THEN 'allowed' 
    WHEN m.CleaningAction = 10 THEN N'blocked' 
  END AS [action],
  CASE       
    WHEN m.ActionSuccess =1 THEN 'true' 
    ELSE 'false' 
  END AS action_result, 
  m.ErrorCode AS action_error_code, 
  CASE 
    WHEN m.PendingActions & 4 <> 0 THEN 'fullscan' 
    WHEN m.PendingActions & 8 <> 0 THEN 'reboot' 
    WHEN m.PendingActions & 16 <> 0 THEN 'settingsmodified' 
    WHEN m.PendingActions & 32768 <> 0 THEN 'systemsweeper' 
    ELSE 'noaction' 
  END AS pending_actionFROM v_GS_Threats m
  LEFT JOIN v_R_System sys on m.ResourceID = sys.ResourceID
  LEFT JOIN v_ThreatCatalog metadata on m.ThreatID = metadata.ThreatID
  LEFT JOIN v_ThreatSeverities sev on metaData.SeverityID=sev.SeverityID 
  LEFT JOIN v_ThreatCategories cat on metaData.CategoryID=cat.CategoryID 
)
select * from malware
{{WHERE m.$rising_column$ > ?}}